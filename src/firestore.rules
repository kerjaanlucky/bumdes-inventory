/**
 * Core Philosophy: This ruleset enforces a multi-tenant security model where each 'branch'
 * acts as a distinct tenant. A user's permissions are strictly scoped to the branch they
 * are assigned to. The rules differentiate between two roles within a branch: 'admin' and 'user'.
 * Admins have full control over their branch's data, while regular users have read-only access.
 *
 * Data Structure: All application data is hierarchically organized under the top-level
 * '/branches' collection. Each branch document contains subcollections for its associated
 * users, items, stock, purchases, and sales (e.g., /branches/{branchId}/items/{itemId}).
 * This structure provides a clear and secure boundary between different branches.
 *
 * Key Security Decisions:
 * - Branch-Scoped Access: A user authenticated for Branch A cannot read, write, or list
 *   data from Branch B. All access checks verify the user's membership and role within
 *   the target branch.
 * - Role-Based Permissions: Branch admins are granted full Create, Read, Update, Delete (CRUD)
 *   permissions on all data within their branch. Standard users are restricted to read-only
 *   permissions for most data.
 * - Client-Side Branch Creation Disabled: To ensure administrative control, the creation
 *   of new branches is disallowed from the client. This operation must be performed through a
 *   trusted server-side environment.
 * - User Listing Restricted: Only branch admins can list the users within their branch.
 *
 * Denormalization for Authorization: To ensure fast and efficient authorization, the `branchId`
 * is denormalized (copied) onto every document within a branch's subcollections (e.g., items,
 * sales). This avoids slow and costly `get()` calls to parent documents and allows rules
 * to make authorization decisions based on the document's own data. User roles are checked
 * by performing a single `get()` on the requesting user's profile document within the target branch.
 *
 * Structural Segregation: The use of distinct collections per branch (/branches/{branchId})
 * inherently segregates data, ensuring that queries for one branch's data cannot accidentally
 * leak data from another.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     * Used for document ownership checks.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    /**
     * Retrieves the requesting user's profile document from within a specific branch.
     * This is the primary function for fetching a user's role for authorization.
     */
    function requestingUserDoc(branchId) {
      return get(/databases/$(database)/documents/branches/$(branchId)/users/$(request.auth.uid));
    }
    
    /**
     * Checks if the requesting user is a registered member of the specified branch.
     */
    function isUserInBranch(branchId) {
      return exists(/databases/$(database)/documents/branches/$(branchId)/users/$(request.auth.uid));
    }

    /**
     * Checks if the requesting user has the 'admin' role within the specified branch.
     */
    function isAdminInBranch(branchId) {
      return isUserInBranch(branchId) && requestingUserDoc(branchId).data.role == 'admin';
    }

    /**
     * Checks if the requesting user has the 'user' role (Kasir) within the specified branch.
     */
    function isCashierInBranch(branchId) {
      return isUserInBranch(branchId) && requestingUserDoc(branchId).data.role == 'user';
    }

    /**
     * Validates that the branchId in a new document's data matches the branchId from the path.
     * Enforces relational integrity on create.
     */
    function isBranchConsistentOnCreate(branchId) {
      return request.resource.data.branchId == branchId;
    }
    
    /**
     * Enforces that the branchId of a document cannot be changed during an update.
     */
    function isBranchImmutableOnUpdate() {
       return request.resource.data.branchId == resource.data.branchId;
    }
    
    /**
     * Enforces immutability for critical User fields on update.
     * Prevents a user from changing their own ID, branch, or role.
     * Admins are exempt from the role immutability check.
     */
    function isUserUpdateValid(branchId) {
      let isCoreInfoImmutable = request.resource.data.uid == resource.data.uid && request.resource.data.branchId == resource.data.branchId;
      let isRoleUpdateAllowed = isAdminInBranch(branchId) || request.resource.data.role == resource.data.role;
      return isCoreInfoImmutable && isRoleUpdateAllowed;
    }
    
    //-------------------------------------------------------------------------
    // Collection Rules
    //-------------------------------------------------------------------------

    /**
     * @description Manages business branch documents.
     * @path /branches/{branchId}
     * @allow (get, list) An authenticated user can read branch info.
     * @allow (update) An 'admin' of this branch can update its details.
     * @deny (create) A user cannot create a new branch from the client.
     * @deny (delete) A non-admin user cannot delete a branch.
     * @principle Restricts sensitive write operations (create, update) to authorized roles (branch admins).
     */
    match /branches/{branchId} {
      allow get, list: if isSignedIn();
      allow create: if false; // Branch creation must be done server-side
      allow update: if isSignedIn() && isAdminInBranch(branchId);
      allow delete: if isSignedIn() && isAdminInBranch(branchId);

      /**
       * @description Manages user profiles within a specific branch.
       * @path /branches/{branchId}/users/{userId}
       * @allow (get) A user can read their own profile, and a branch admin can read any user profile in their branch.
       * @allow (create) Anyone can create their own user profile during sign-up, but only in the specified branch. An admin can create any user.
       * @allow (update) A user can update their own profile (but not their role), and an admin can update any profile.
       * @deny (list) A regular user cannot list all users in the branch.
       * @deny (delete) A regular user cannot delete another user's profile.
       * @principle Enforces a mix of document ownership and role-based access for user data management.
       */
      match /users/{userId} {
        allow get: if isSignedIn() && (isOwner(userId) || isAdminInBranch(branchId));
        allow list: if isSignedIn() && isAdminInBranch(branchId);
        // Allow user to create their own doc, or an admin to create any.
        allow create: if isSignedIn() && (isOwner(userId) || isAdminInBranch(branchId)) && request.resource.data.uid == userId;
        allow update: if isSignedIn() && (isOwner(userId) || isAdminInBranch(branchId)) && isUserUpdateValid(branchId);
        allow delete: if isSignedIn() && isAdminInBranch(branchId);
      }

      /**
       * @description Manages master item data for a branch.
       * @path /branches/{branchId}/items/{itemId}
       * @allow (read) Any user belonging to the branch can read item data.
       * @allow (write) Only an admin of the branch can modify item data.
       * @principle Enforces branch-scoped, role-based access control. Read access for members, write access for admins.
       */
      match /items/{itemId} {
        allow read: if isSignedIn() && isUserInBranch(branchId);
        allow write: if isSignedIn() && isAdminInBranch(branchId);
      }

      /**
       * @description Manages stock levels for items within a branch.
       * @path /branches/{branchId}/stocks/{stockId}
       * @allow (read) Any user belonging to the branch can read stock levels.
       * @allow (write) Only an admin of the branch can modify stock data.
       * @principle Enforces branch-scoped, role-based access control.
       */
      match /stocks/{stockId} {
        allow read: if isSignedIn() && isUserInBranch(branchId);
        allow write: if isSignedIn() && isAdminInBranch(branchId);
      }

      /**
       * @description Manages purchase orders for a branch.
       * @path /branches/{branchId}/purchases/{purchaseId}
       * @allow (read) Any user belonging to the branch can read purchase orders.
       * @allow (write) Only an admin of the branch can manage purchase orders.
       * @principle Enforces branch-scoped, role-based access control. Read for members, write for admins.
       */
      match /purchases/{purchaseId} {
        allow read: if isSignedIn() && isUserInBranch(branchId);
        allow write: if isSignedIn() && isAdminInBranch(branchId);

        /**
         * @description Manages the line items within a purchase order.
         * @path /branches/{branchId}/purchases/{purchaseId}/purchaseItems/{purchaseItemId}
         * @principle Access is inherited from the parent branch and collection.
         */
        match /purchaseItems/{purchaseItemId} {
          allow read: if isSignedIn() && isUserInBranch(branchId);
          allow write: if isSignedIn() && isAdminInBranch(branchId);
        }
      }

      /**
       * @description Manages sales transactions for a branch.
       * @path /branches/{branchId}/sales/{saleId}
       * @allow (read) Any user belonging to the branch can read sales transactions.
       * @allow (create) Any user (admin or cashier) can create sales transactions in their branch.
       * @allow (update, delete) Only an admin of the branch can modify/delete sales.
       * @principle Allows cashiers to create sales, but restricts modifications to admins.
       */
      match /sales/{saleId} {
        allow read: if isSignedIn() && isUserInBranch(branchId);
        allow create: if isSignedIn() && (isAdminInBranch(branchId) || isCashierInBranch(branchId)) && isBranchConsistentOnCreate(branchId);
        allow update, delete: if isSignedIn() && isAdminInBranch(branchId);

        /**
         * @description Manages the line items within a sales transaction.
         * @path /branches/{branchId}/sales/{saleId}/saleItems/{saleItemId}
         * @principle Access is inherited from the parent branch and collection.
         */
        match /saleItems/{saleItemId} {
          allow read: if isSignedIn() && isUserInBranch(branchId);
          allow create: if isSignedIn() && (isAdminInBranch(branchId) || isCashierInBranch(branchId));
          allow update, delete: if isSignedIn() && isAdminInBranch(branchId);
        }
      }
    }
  }
}
